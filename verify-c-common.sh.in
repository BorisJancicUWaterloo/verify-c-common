#!/bin/bash
SCRIPT_DIR="$( cd "$( dirname "$0" )" && pwd )"
VERIFICATION_BASE_CONFIG="$SCRIPT_DIR/seahorn/sea.yaml"

: ${1?"Usage: $0 <bitcode_file> <expected_result>  Need to pass bitcode file to verify"}
: ${2?"Usage: $0 <bitcode_file> <expected_result>  Need to pass expected result"}

function runOnFile {
    INPUT_FILE=${1}
    EXPECT=${2}
    VERBOSE=${3}
    BASE_CONFIG=${4}
    JOB_CONFIG=${5}
    OTHER_FLAGS=${6}

    cmd=''
    cmd+="${SEA_DIR}/sea yama --yforce -y $VERIFICATION_BASE_CONFIG -y $JOB_CONFIG fpf $OTHER_FLAGS $INPUT_FILE "
    cmd+=" 2>&1 "
    if [ $VERBOSE -eq 1 ]; then
        echo $cmd
        cmd+=" | tee /dev/tty "
    fi
    cmd+=" | egrep -c \"^${EXPECT}$\""
    r=$(eval $cmd)
    return $r

}

INPUT_FILE=${1}
SEA_DIR="@SEAHORN_ROOT@/bin"
EXPECT=$2
OTHER_FLAGS=${@:3}

VERBOSE_ARG=1

if [[ $0 =~ .*-silent.sh ]]; then
   VERBOSE_ARG=0
else
   VERBOSE_ARG=1
fi

if [[ $0 =~ .*-cex.sh ]]; then
   VERIFICATION_BASE_CONFIG="$SCRIPT_DIR/seahorn/sea.cex.yaml"
fi

sea_yaml="$(dirname $INPUT_FILE)/../../sea.yaml"
runOnFile $INPUT_FILE "$EXPECT" $VERBOSE_ARG $VERIFICATION_BASE_CONFIG ${sea_yaml} "$OTHER_FLAGS"
result=$?
if [ $result -eq 1 ]; then
    exit 0
else
    exit 1
fi
